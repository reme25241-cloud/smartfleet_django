{% extends 'fleet/base.html' %}
{% load fleet_extras %}
{% block title %}Trip Closure Dashboard{% endblock %}
{% block content %}
<h1 class="text-3xl font-semibold mb-6">Trip Closure Dashboard</h1>

<form method="get" class="mb-4">
  <label class="block text-sm mb-1 text-gray-300">Search by Trip ID</label>
  <div class="flex gap-4">
    <input type="text" name="search_trip_id" value="{{ request.GET.search_trip_id }}" class="text-black px-4 py-2 rounded" placeholder="Enter Trip ID">
    <button type="submit" class="bg-yellow-500 px-4 py-2 rounded hover:bg-yellow-600">Search</button>
  </div>
</form>

<form method="get" class="mb-6 flex flex-wrap gap-4">
  <label>Start Date: <input type="date" name="start_date" value="{{ request.GET.start_date }}" class="text-black rounded px-2 py-1"></label>
  <label>End Date: <input type="date" name="end_date" value="{{ request.GET.end_date }}" class="text-black rounded px-2 py-1"></label>
  <button type="submit" class="bg-green-600 px-4 py-2 rounded hover:bg-green-700">Filter</button>
</form>

<form method="POST" enctype="multipart/form-data" class="mb-6">
  {% csrf_token %}
  <label class="block text-sm text-gray-300 mb-2">Upload Trip Excel Sheet</label>
  <input type="file" name="excel_file" accept=".xlsx,.xls" class="mb-4 px-3 py-2 rounded bg-white text-black">
  <button type="submit" class="bg-blue-600 px-4 py-2 rounded hover:bg-blue-700">Upload & Insert</button>
</form>

<form id="edit-form" method="POST" class="bg-[#3A506B] p-6 rounded-lg grid md:grid-cols-2 gap-4 mb-8">
  {% csrf_token %}
  <div>
    <label class="block text-sm text-gray-200 font-bold mb-2">Trip ID</label>
    <input name="trip_id" value="{{ trip_data.trip_id }}" required class="w-full px-3 py-2 rounded bg-gray-200 text-black" type="text" placeholder="Enter Trip ID to close">
  </div>
  {% for f,label,ftype in fields %}
    <div>
      <label class="block text-sm text-gray-200 capitalize mb-2">{{ label }}</label>
      <input name="{{ f }}" value="{{ trip_data|get_item:f }}" class="w-full px-3 py-2 rounded bg-gray-200 text-black" type="{{ ftype }}">
    </div>
  {% endfor %}
  <button type="submit" class="mt-6 bg-[#1C2541] hover:bg-[#3A506B] px-4 py-2 rounded text-white md:col-span-2">Submit Trip Closure</button>
</form>

<h2 class="text-xl font-semibold mb-4">Recent Trip Closures</h2>
<div class="overflow-x-auto">
  <table class="min-w-full bg-[#1C2541] rounded-lg overflow-hidden">
    <thead class="bg-[#3A506B] text-white">
      <tr>{% for col in closures_columns %}<th class="text-left px-4 py-2">{{ col }}</th>{% endfor %}</tr>
    </thead>
    <tbody>
      {% for row in closures_rows %}
      <tr class="border-b border-gray-600">
        <td class="px-4 py-2"><a href="?search_trip_id={{ row.trip_id }}" class="text-blue-400 hover:underline">{{ row.trip_id }}</a></td>
        {% for f,label,_ in fields %}<td class="px-4 py-2">{{ row|get_item:f }}</td>{% endfor %}
      </tr>
      {% empty %}
      <tr><td colspan="{{ closures_colspan }}" class="px-4 py-2 text-center text-gray-400">No trip closures recorded yet.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}
