{% extends 'fleet/base.html' %}
{% load fleet_extras %}
{% block title %}Trip Auditor Dashboard{% endblock %}
{% block content %}
<h1 class="text-2xl font-bold mb-4">Trip Auditor Dashboard</h1>
<div class="grid md:grid-cols-4 gap-4 mb-6">
  <div class="bg-[#161B22] p-4 rounded text-center"><h2 class="text-sm text-gray-400">Total Trips Generated</h2><p class="text-2xl">{{ total_trips }}</p></div>
  <div class="bg-[#161B22] p-4 rounded text-center"><h2 class="text-sm text-gray-400">Trips Opened vs Audited</h2><p class="text-2xl">{{ opened }} / {{ audited }}</p></div>
  <div class="bg-[#161B22] p-4 rounded text-center"><h2 class="text-sm text-gray-400">Trips Closed vs Audited</h2><p class="text-2xl">{{ closed }} / {{ audit_closed }}</p></div>
  <div class="bg-[#161B22] p-4 rounded text-center"><h2 class="text-sm text-gray-400">Flags</h2><p class="text-2xl">{{ flags }}</p></div>
</div>
<form method="get" class="mb-4">
  <label>Filter:
    <select name="filter" onchange="this.form.submit()" class="bg-[#0D1117] border border-gray-600 rounded p-2">
      <option value="all" {% if filter_option == 'all' %}selected{% endif %}>All</option>
      <option value="open" {% if filter_option == 'open' %}selected{% endif %}>Open</option>
      <option value="closed" {% if filter_option == 'closed' %}selected{% endif %}>Closed</option>
      <option value="flag" {% if filter_option == 'flag' %}selected{% endif %}>Flag</option>
    </select>
  </label>
</form>
<div class="bg-[#161B22] p-4 rounded mb-6"><canvas id="tripChart"></canvas></div>
<script>
const ctx = document.getElementById('tripChart').getContext('2d');
const chart = new Chart(ctx, {
  data: {
    labels: Array.from({length:31}, (_,i)=> `Day ${i+1}`),
    datasets: [
      { type:'bar', label:'Closed Trips', data: {{ closed_data|safe }} },
      { type:'bar', label:'Audited Trips', data: {{ audited_data|safe }} },
      { type:'line', label:'Audit %', data: {{ audit_pct|safe }}, yAxisID:'y1', borderColor:'lime', borderWidth:2, fill:false, tension:0.3 }
    ]
  },
  options: { responsive:true, scales: { y: {beginAtZero:true}, y1: {beginAtZero:true, position:'right'} } }
});
</script>
<div class="bg-[#161B22] p-4 rounded">
  <h2 class="text-lg mb-2">Trips (Filter: {{ filter_option|capfirst }})</h2>
  <div class="overflow-x-auto">
  <table class="w-full"><thead><tr><th class="text-left p-2">Trip ID</th><th class="text-left p-2">Actions</th></tr></thead>
  <tbody>
    {% for trip in trips %}<tr><td class="p-2">{{ trip|get_item:"trip id" }}</td><td class="p-2"><a class="bg-blue-600 px-3 py-1 rounded" href="{% url 'audit_trip' trip|get_item:"trip id" %}">Audit</a></td></tr>{% endfor %}
  </tbody></table>
  </div>
</div>
{% endblock %}
