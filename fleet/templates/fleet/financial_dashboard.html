{% extends 'fleet/base.html' %}
{% block title %}Revenue Dashboard{% endblock %}
{% block content %}
<h2 class="text-2xl mb-4">Revenue Dashboard</h2>
<form method="POST" enctype="multipart/form-data" class="mb-4">
  {% csrf_token %}
  <input type="file" name="file" accept=".xlsx" required class="bg-white text-black p-2 rounded">
  <button type="submit" class="ml-2 px-4 py-2 bg-blue-600 rounded">Upload Excel</button>
</form>
<div class="grid md:grid-cols-3 gap-4 mb-6 text-center">
  <div class="bg-[#161B22] p-4 rounded"><h1 class="text-3xl">₹{{ total_revenue }} M</h1><div>Total Revenue</div></div>
  <div class="bg-[#161B22] p-4 rounded"><h1 class="text-3xl">₹{{ total_profit }} M</h1><div>Total Profit</div></div>
  <div class="bg-[#161B22] p-4 rounded"><h1 class="text-3xl">{{ total_km }} K</h1><div>Total KM Cost</div></div>
</div>
<canvas id="financeChart" height="100"></canvas>
<script>
const ctx = document.getElementById('financeChart').getContext('2d');
const chart = new Chart(ctx, {
  type:'bar',
  data: { labels: {{ days|safe }}, datasets:[
    { label:'Total Revenue', data: {{ revenue|safe }} },
    { label:'Total Expense', data: {{ expense|safe }} },
    { label:'Trip Profit', data: {{ profit|safe }} }
  ] },
  options: { responsive:true }
});
</script>
{% endblock %}

<script>
// --- CSRF-safe drag & drop + click-to-upload for Django ---
(function() {
  
  const dropArea = document.getElementById('drop-area') || document.querySelector('.drop-area') || document.body;
  const fileInput = (function() {
    let el = document.getElementById('fileElem') || document.querySelector('input[type="file"]');
    if (!el) {
      el = document.createElement('input');
      el.type = 'file';
      el.style.display = 'none';
      document.body.appendChild(el);
    }
    el.id = el.id || 'fileElem';
    return el;
  })();
  const statusDiv = document.getElementById('upload-status') || (function() {
    const d = document.createElement('div');
    d.id = 'upload-status';
    d.style.marginTop = '0.5rem';
    (dropArea || document.body).appendChild(d);
    return d;
  })();

  function preventDefaults (e) {
    e.preventDefault();
    e.stopPropagation();
  }

  ['dragenter','dragover','dragleave','drop'].forEach(eventName => {
    dropArea.addEventListener(eventName, preventDefaults, false);
  });

  ['dragenter','dragover'].forEach(eventName => {
    dropArea.addEventListener(eventName, () => dropArea.classList && dropArea.classList.add('bg-gray-200'), false);
  });
  ['dragleave','drop'].forEach(eventName => {
    dropArea.addEventListener(eventName, () => dropArea.classList && dropArea.classList.remove('bg-gray-200'), false);
  });

  dropArea.addEventListener('drop', e => {
    const dt = e.dataTransfer;
    const file = dt && dt.files && dt.files[0];
    if (file) uploadFile(file);
  });

  dropArea.addEventListener('click', () => fileInput && fileInput.click());
  fileInput.addEventListener('change', () => {
    const file = fileInput.files && fileInput.files[0];
    if (file) uploadFile(file);
  });

  function uploadFile(file) {
    const formData = new FormData();
    // Support both 'excel' and 'file' server-side field names.
    formData.append('excel', file);
    formData.append('file', file);

    statusDiv.textContent = '⬆️ Uploading...';

    fetch('', {
      method: 'POST',
      body: formData,
      \1 getCSRFToken() }
    })
    .then(async (r) => {
      if (r.ok) {
        statusDiv.textContent = '✅ File uploaded successfully. Refreshing...';
        setTimeout(() => { try { window.location.reload(); } catch(_) {} }, 900);
      } else {
        const t = await r.text().catch(()=>'');
        console.error('Upload failed:', r.status, t);
        statusDiv.textContent = '❌ Upload failed!';
      }
    })
    .catch(err => {
      console.error('Upload error:', err);
      statusDiv.textContent = '❌ Upload failed!';
    });
  }
})();
</script>
