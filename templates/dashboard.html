<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <title>{{ title|default:"Smart Fleet Ai" }}</title>
</head>

<body class="bg-[#0B132B] text-white p-6 font-sans">
  <nav class="bg-[#1C2541] p-4 rounded flex justify-between items-center mb-6">
    <div class="flex gap-4 text-sm sm:text-base">
      <a href="{% url 'user_settings' %}" class="text-white hover:underline">User Settings</a>
      <a href="{% url 'trip_generator' %}" class="text-white hover:underline">Trip Generator</a>
      <a href="{% url 'trip_closure' %}" class="text-white hover:underline">Trip Closure</a>
      <a href="{% url 'trip_audit' %}" class="text-white hover:underline">Trip Audit</a>
      <a href="{% url 'financial_dashboard' %}" class="text-white hover:underline">Financial Dashboard</a>
    </div>
    <div><a href="{% url 'logout' %}" class="bg-red-600 px-3 py-1 rounded hover:bg-red-700">Logout</a></div>
  </nav>

  <h1 class="text-3xl font-bold mb-6">Fleet Dashboard</h1>
  <div class="mb-6">
    <h2 class="text-lg font-semibold mb-2">Upload Excel File</h2>
    <form id="upload-form" method="post" enctype="multipart/form-data">
      {% csrf_token %}
      <div id="drop-area" class="border-2 border-dashed border-gray-400 p-6 rounded bg-white text-black text-center cursor-pointer hover:bg-gray-100">
        <p class="text-gray-700">Drag & Drop your Excel file here or click to upload</p>
        <input type="file" id="fileElem" name="excel" class="hidden" accept=".xlsx,.xls">
      </div>
    </form>
    <div id="upload-status" class="mt-2 text-sm text-green-400"></div>
  </div>

<script>
  const dropArea = document.getElementById('drop-area');
  const fileElem = document.getElementById('fileElem');
  const uploadForm = document.getElementById('upload-form');
  const statusDiv = document.getElementById('upload-status');
  dropArea.addEventListener('click', () => fileElem.click());
  ['dragenter','dragover'].forEach(ev => dropArea.addEventListener(ev, e => {e.preventDefault(); dropArea.classList.add('bg-gray-200');}));
  ['dragleave','drop'].forEach(ev => dropArea.addEventListener(ev, e => {e.preventDefault(); dropArea.classList.remove('bg-gray-200');}));
  dropArea.addEventListener('drop', e => { const file = e.dataTransfer.files[0]; uploadFile(file); });
  fileElem.addEventListener('change', () => { const file = fileElem.files[0]; uploadFile(file); });
  function uploadFile(file){
    if(!file) return;
    const formData = new FormData();
    formData.append('excel', file);
    fetch('', { method:'POST', body: formData, headers: {'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value}})
     .then(r => { if(r.ok){ statusDiv.textContent='✅ File uploaded successfully! Refreshing...'; setTimeout(()=>location.reload(), 1200);} else { statusDiv.textContent='❌ Upload failed!'; }})
     .catch(()=> statusDiv.textContent='❌ Upload error!');
  }
</script>

  <form method="get" class="flex flex-wrap gap-4 mb-6">
    <select name="vehicle" class="text-black p-2 rounded"><option value="">All Vehicles</option>
      {% for v in vehicles %}<option value="{{v}}">{{v}}</option>{% endfor %}
    </select>
    <select name="route" class="text-black p-2 rounded"><option value="">All Routes</option>
      {% for r in routes %}<option value="{{r}}">{{r}}</option>{% endfor %}
    </select>
    <input type="date" name="start" class="text-black p-2 rounded">
    <input type="date" name="end" class="text-black p-2 rounded">
    <button class="bg-green-600 px-4 py-2 rounded">Apply Filters</button>
  </form>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <div class="bg-[#1C2541] p-4 rounded">
      <p>Total Trips: <b>{{ total_trips }}</b></p>
      <p>Ongoing: <b>{{ ongoing }}</b></p>
      <p>Closed: <b>{{ closed }}</b></p>
      <p>Flags: <b>{{ flags }}</b></p>
      <p>Resolved: <b>{{ resolved }}</b></p>
    </div>
    <div class="bg-[#1C2541] p-4 rounded">
      <p class="font-bold mb-2 text-lg">Financial Summary</p>
      <p>Revenue: ₹{{ rev_m }}M</p>
      <p>Expense: ₹{{ exp_m }}M</p>
      <p>Profit: ₹{{ profit_m }}M</p>
      <p>KMs: {{ kms_k }}K</p>
      <p>Per KM: ₹{{ per_km }}</p>
      <p>Profit %: {{ profit_pct }}%</p>
    </div>
    <div class="bg-[#1C2541] p-4 rounded">
      <p class="font-bold mb-2">AI Report</p>
      <pre class="text-sm text-gray-300">{{ ai_report }}</pre>
      <a href="{% url 'download_summary' %}" class="mt-2 inline-block bg-green-600 px-3 py-1 rounded hover:bg-green-700">Download Summary</a>
    </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
    <div class="bg-[#1C2541] p-4 rounded"><h2 class="mb-2 font-semibold text-lg">Daily Trips vs Audits</h2><canvas id="auditChart" height="120"></canvas></div>
    <div class="bg-[#1C2541] p-4 rounded"><h2 class="mb-2 font-semibold text-lg">Finance Chart</h2><canvas id="financeChart" height="120"></canvas></div>
  </div>

<script>
  new Chart(document.getElementById('auditChart').getContext('2d'), {
    data: {labels: Array.from({length:31}, (_,i)=> i+1),
      datasets:[
        {type:'bar', label:'Closed', data: {{ daily|safe }}, },
        {type:'bar', label:'Audited', data: {{ audited|safe }}, },
        {type:'line', label:'Audit %', data: {{ audit_pct|safe }}, yAxisID:'y1', borderColor:'yellow', fill:false}
    ]},
    options:{responsive:true, scales:{y:{beginAtZero:true}, y1:{beginAtZero:true, position:'right', grid:{drawOnChartArea:false}}}}
  });
  new Chart(document.getElementById('financeChart').getContext('2d'), {
    type:'bar', data:{ labels: {{ bar_labels|safe }}, datasets:[{label:'₹ in Millions', data: {{ bar_values|safe }} }]},
    options:{responsive:true}
  });
</script>

</body></html>
